---
title: "systemPipeR_apoptosis_pipeline"
output: pdf_document
---
## Collect SRA data from NCBI:

Used two different scripts in the URI cluster in order to process paired end read files and single end files.

  For single end reads: fetchSRA.sh
  For paired end reads: fetchSRA_paired.sh
  
  When using, make sure the working directory has *.txt endings for only the SE read files, and *_paired.text for only the PE read files. These file endings are used as filters in the script.


Install bioconductor
```{r}
#install bioconductor
source( "http://www.bioconductor.org/biocLite.R") 
biocLite("BiocUpgrade") 
biocLite(c("ShortRead","DESeq", "edgeR") )
```



## Load systemPipeR library and documentation
```{r}
source("http://bioconductor.org/biocLite.R") # Sources the biocLite.R installation script 
biocLite("systemPipeR") # Installs systemPipeR 
biocLite("systemPipeRdata") # Installs systemPipeRdata
library("systemPipeR") # Loads the package
#library(help="systemPipeR") # Lists package info

library(systemPipeRdata)
genWorkenvir(workflow="rnaseq", mydirname = /data3/marine_diseases_lab/erin/Bio_project_SRA/PE_fastq) #change to cluster directory 
setwd("rnaseq")
```

##Access the targets file

Access the targets file (SE) samples, Construct SYSargs object from param and targets files.
```{r}
#library(systemPipeR)
#targetspath <- system.file("extdata", "targets_SE.txt", package="systemPipeR")
#read.delim(targetspath, comment.char = "#")
#Path specified in the targets_SE.txt file

```


## Access the targets file (PE) samples (second time running through script)
```{r}
targetspath <- system.file("extdata", "targets_PE.txt", package="systemPipeR")
read.delim(targetspath2, comment.char = "#")[1:2,1:6]
```

## Sample Comparisons for PE
Sample comparisons are defined in the header lines of the targets file starting with ‘# <CMP>’.

```{r }
readLines(targetspath)[1:5] #set because the CMPs are listed rows 1-5
```

The function readComp imports the comparison information and stores it in a list. 
```{r }
readComp(file=targetspath, format="vector", delim="-")
```

## Construct Sysargs object
```{r }
args <- systemArgs(sysma="param/trim.param", mytargets="targets_PE.txt")
```

## Read Pre-processing
The paths to the resulting output FASTQ files are stored in the outpaths slot of the SYSargs object. 

1. bbtools_trim_paired.sh run in cluster to trim adapters off the end of reads, to perform quality trimming at the ends of reads with quality less than Phred score 10, and quality filter out all sequences with a quality below phred score 10. Path to these pre-processed files is used in the targets_PE.txt file.

This script also produces histogram reports of each run containing information on: base frequency, quality scores, gc content, average quality, and length.

## Alignment with Tophat2

Tophat2 will be used to map reads to the Crassostrea gigas reference genome available from Ensembl. 
Cufflinks will then be used to perform transcript identification and quantification using the GFF3 file for C. gigas available at Ensembl at the following web address: http://metazoa.ensembl.org/Crassostrea_gigas/Info/Index

Build Bowtie2 index:
```{r}
args <- systemArgs(sysma="bowtiePE.param", mytargets="targets_PE.txt")
moduleload(modules(args)) # Skip if module system is not available
bampaths <- runCommandline(args=args)
```

## Read and Alignment Count stats
Table of Read and Alignment Count stats
``` {r}
read_statsDF <- alignStats(args) 
write.table(read_statsDF, "results/alignStats.xls", row.names=FALSE, quote=FALSE, sep="\t")
```

## Read counting for mRNA profiling experiments
Need to create a txdb 
```{r}
library(GenomicFeatures)
txdb <- makeTxDbFromGFF(file="data/tair10.gff", format="gff", dataSource="TAIR", organism="C. gigas")
saveDb(txdb, file="./data/tair10.sqlite")
```


## Heatmap analysis
``` {r}
library(pheatmap)
geneids <- unique(as.character(unlist(DEG_list[[1]])))
y <- assay(rlog(dds))[geneids, ]
pdf("heatmap1.pdf")
pheatmap(y, scale="row", clustering_distance_rows="correlation", clustering_distance_cols="correlation")
dev.off()
```
